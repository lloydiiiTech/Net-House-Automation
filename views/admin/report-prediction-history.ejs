<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prediction History - NetHouseAutomation</title>
    <link href="/assets/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="/assets/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="/assets/vendors/themify-icons/css/themify-icons.css" rel="stylesheet" />
    <link href="/assets/css/main.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #2a7f62;
            --alt-accent: #17a2b8;
            --card-shadow: 0 12px 32px rgba(42,127,98,0.12);
            --radius: 18px;
        }
        body {
            background: linear-gradient(135deg, #f5faf7 0%, #e8f0fb 100%);
            font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
        }
        .page-title {
            color: var(--primary-color);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }
        .summary-bar {
            background: linear-gradient(120deg, #2a7f62 0%, #1a5f4a 100%);
            color: #fff;
            border-radius: var(--radius);
            padding: 1.25rem 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            box-shadow: var(--card-shadow);
        }
        .summary-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.05rem;
        }
        .summary-item .badge {
            background: rgba(255,255,255,0.15);
            border-radius: 999px;
            padding: 0.35rem 0.9rem;
            font-weight: 600;
            color: #fff;
        }
        .info-card {
            background: #fff;
            border-radius: var(--radius);
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            height: 100%;
        }
        .info-card h5 {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        .recommendation-section {
            margin-top: 2rem;
        }
        .recommendation-header {
            background: linear-gradient(120deg, #2a7f62 0%, #1a5f4a 100%);
            color: #fff;
            border-radius: var(--radius) var(--radius) 0 0;
            padding: 1.1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--card-shadow);
        }
        .recommendation-grid {
            background: #fff;
            border-radius: 0 0 var(--radius) var(--radius);
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .recommendation-card {
            display: flex;
            gap: 1rem;
            align-items: center;
            border: 1px solid #e3ece7;
            border-radius: 16px;
            padding: 1rem 1.25rem;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
        }
        .recommendation-card:hover {
            transform: translateY(-2px);
            border-color: #2a7f62;
            box-shadow: 0 6px 20px rgba(42,127,98,0.18);
        }
        .crop-rank {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: #2a7f62;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.25rem;
        }
        .crop-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2a7f62;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }
        .crop-status {
            padding: 0.2rem 0.8rem;
            border-radius: 999px;
            font-size: 0.85rem;
            color: #fff;
            font-weight: 600;
        }
        .crop-status.registered { background: #28a745; }
        .crop-status.unregistered { background: #17a2b8; }
        .crop-match {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin-top: 0.3rem;
        }
        .match-bar {
            width: 140px;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        .match-bar-inner {
            height: 100%;
            border-radius: 4px;
            background: #2a7f62;
        }
        .empty-state {
            background: #fff;
            border-radius: var(--radius);
            padding: 3rem 1.5rem;
            text-align: center;
            box-shadow: var(--card-shadow);
        }
        @media (max-width: 768px) {
            .summary-bar { flex-direction: column; align-items: flex-start; }
            .recommendation-card { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body class="fixed-navbar">
    <div class="page-wrapper">
        <header class="header">
            <div class="page-brand">
                <a class="link" href="/dashboard">
                    <span class="brand">AgriNet
                        <span class="brand-tip">TECH</span>
                    </span>
                </a>
            </div>
            <div class="flexbox flex-1">
                <ul class="nav navbar-toolbar">
                    <li>
                        <a class="nav-link sidebar-toggler js-sidebar-toggler"><i class="ti-menu"></i></a>
                    </li>
                </ul>
                <ul class="nav navbar-toolbar">
                    <li class="dropdown dropdown-user">
                        <a class="nav-link dropdown-toggle link" data-toggle="dropdown">
                            <img src="<%= user.profilePicture %>" />
                            <span></span><%= user.name %><i class="fa fa-angle-down m-l-5"></i></a>
                        <ul class="dropdown-menu dropdown-menu-right">
                            <a class="dropdown-item" href="/profile"><i class="fa fa-user"></i>Profile</a>
                            <li class="dropdown-divider"></li>
                            <a class="dropdown-item" href="/logout"><i class="fa fa-power-off"></i>Logout</a>
                        </ul>
                    </li>
                </ul>
            </div>
        </header>
        <nav class="page-sidebar" id="sidebar">
            <div id="sidebar-collapse">
                <div class="admin-block d-flex">
                    <div>
                        <img src="<%= user.profilePicture %>" width="45px" />
                    </div>
                    <div class="admin-info">
                        <div class="font-strong"><%= user.name %></div><small><%= user.role %></small>
                    </div>
                </div>
                <ul class="side-menu metismenu">
                    <li><a href="/dashboard"><i class="sidebar-item-icon fas fa-tachometer-alt"></i><span class="nav-label">Dashboard</span></a></li>
                    <li><a href="/plant-overview"><i class="sidebar-item-icon fas fa-leaf"></i><span class="nav-label">Plant Overview</span></a></li>
                    <li><a href="/irrigation-controll"><i class="sidebar-item-icon fas fa-faucet"></i><span class="nav-label">Irrigation Control</span></a></li>
                    <li>
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                            <i class="sidebar-item-icon fas fa-chart-bar"></i>
                            <span class="nav-label">Reports & Analytics</span>
                            <i class="fa fa-caret-down ml-1"></i>
                        </a>
                        <ul class="dropdown-menu" style="background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                            <li><a class="dropdown-item" href="/report-crops">Crops Report</a></li>
                            <li><a class="dropdown-item" href="/report-daily-sensors">Daily Sensors Data</a></li>
                            <li><a class="dropdown-item" href="/report-irrigation">Irrigation Records</a></li>
                            <li><a class="dropdown-item" href="/report-planted-crops">Planted Crops</a></li>
                            <li><a class="dropdown-item" href="/report-ai-disease">AI Disease & Fertilizer</a></li>
                        </ul>
                    </li>
                    <li><a href="/user-management"><i class="sidebar-item-icon fas fa-users-cog"></i><span class="nav-label">User Management</span></a></li>
                    <li><a class="active" href="/report-prediction-history"><i class="sidebar-item-icon fas fa-history"></i><span class="nav-label">Prediction History</span></a></li>
                </ul>
            </div>
        </nav>
        <div class="content-wrapper">
            <div class="page-content fade-in-up">
                <div class="page-heading d-flex justify-content-between align-items-center flex-wrap">
                    <h1 class="page-title">
                        <i class="fa fa-history"></i>
                        Prediction History
                    </h1>
                    <span class="text-muted">Page <%= currentPage %> of <%= totalPages %></span>
                </div>

                <% if (typeof error !== 'undefined' && error) { %>
                    <div class="alert alert-danger shadow-sm border-0"><i class="fa fa-exclamation-circle mr-2"></i><%= error %></div>
                <% } %>

                <% if (!currentPrediction) { %>
                    <div class="empty-state mt-4">
                        <i class="fa fa-database fa-3x text-muted mb-3"></i>
                        <h4>No prediction entries available</h4>
                        <p class="text-muted mb-0">Once the AI generates recommendations, they will appear here with full details.</p>
                    </div>
                <% } else { %>
                    <div class="summary-bar mt-3 mb-4">
                        <div class="summary-item">
                            <i class="fa fa-calendar"></i>
                            Prediction Date:
                            <span class="badge"><%= currentPrediction.displayDate %></span>
                        </div>
                        <div class="summary-item">
                            <i class="fa fa-microchip"></i>
                            Suggestions:
                            <span class="badge"><%= currentPrediction.stats.totalRecommendations %></span>
                        </div>
                        <div class="summary-item">
                            <i class="fa fa-seedling"></i>
                            Registered:
                            <span class="badge"><%= currentPrediction.stats.registeredCount %></span>
                        </div>
                        <div class="summary-item">
                            <i class="fa fa-leaf"></i>
                            Unregistered:
                            <span class="badge"><%= currentPrediction.stats.unregisteredCount %></span>
                        </div>
                        <div class="summary-item">
                            <i class="fa fa-robot"></i>
                            Model:
                            <span class="badge"><%= currentPrediction.modelVersion %></span>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-lg-6 mb-3">
                            <div class="info-card h-100">
                                <h5><i class="fa fa-thermometer-half mr-2 text-success"></i>Sensor Snapshot</h5>
                                <% const sensorEntries = Object.entries(currentPrediction.sensorData || {}); %>
                                <% if (!sensorEntries.length) { %>
                                    <p class="text-muted mb-0">No sensor data stored for this run.</p>
                                <% } else { %>
                                    <table class="table table-borderless mb-0">
                                        <tbody>
                                            <% sensorEntries.forEach(([key,val]) => { %>
                                                <tr>
                                                    <td class="text-uppercase text-muted" style="width:45%;"><%= key.replace(/_/g,' ') %></td>
                                                    <td><%= val !== null && val !== undefined ? val : 'N/A' %></td>
                                                </tr>
                                            <% }) %>
                                        </tbody>
                                    </table>
                                <% } %>
                            </div>
                        </div>
                        <div class="col-lg-6 mb-3">
                            <div class="info-card h-100 d-flex flex-column">
                                <h5><i class="fa fa-info-circle mr-2 text-primary"></i>Run Notes</h5>
                                <p class="text-muted mb-3"><%= currentPrediction.notes || 'No notes recorded for this prediction.' %></p>
                                <div class="mt-auto">
                                    <table class="table table-borderless mb-0">
                                        <tbody>
                                            <tr>
                                                <td>Document ID</td>
                                                <td><code><%= currentPrediction.id %></code></td>
                                            </tr>
                                            <tr>
                                                <td>Timestamp</td>
                                                <td><%= currentPrediction.displayDate %></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="prediction-data" data-prediction='<%- JSON.stringify(currentPrediction) %>'></div>

                    <section class="recommendation-section">
                        <div class="recommendation-header">
                            <span><i class="fa fa-check-circle mr-2"></i>Top 5 Registered Crops</span>
                            <span class="badge badge-light text-dark"><%= currentPrediction.top5Registered.length %> entries</span>
                        </div>
                        <div class="recommendation-grid">
                            <% if (!currentPrediction.top5Registered.length) { %>
                                <div class="alert alert-info mb-0"><i class="fa fa-info-circle mr-2"></i>No registered crops for this prediction.</div>
                            <% } else { %>
                                <% currentPrediction.top5Registered.forEach(function(crop, idx) { %>
                                    <div class="recommendation-card" onclick="openCropModal('registered', <%= idx %>)">
                                        <div class="crop-rank"><%= idx + 1 %></div>
                                        <div class="w-100">
                                            <div class="crop-name">
                                            <%= crop.name %>
                                                <span class="crop-status registered">Registered</span>
                                            </div>
                                            <div class="crop-match">
                                                <div class="match-bar">
                                                    <div class="match-bar-inner" style="width:<%= Math.min(100, Math.round(crop.score || crop.ruleBasedScore || 0)) %>%"></div>
                                                </div>
                                                <span><%= Math.round(crop.score || crop.ruleBasedScore || 0) %>% Match</span>
                                            </div>
                                        </div>
                                    </div>
                                <% }); %>
                            <% } %>
                        </div>
                    </section>

                    <section class="recommendation-section">
                        <div class="recommendation-header" style="background: linear-gradient(120deg,#17a2b8 0%,#117a8b 100%);">
                            <span><i class="fa fa-lightbulb mr-2"></i>Top 5 Unregistered Crops</span>
                            <span class="badge badge-light text-dark"><%= currentPrediction.top5Unregistered.length %> entries</span>
                        </div>
                        <div class="recommendation-grid">
                            <% if (!currentPrediction.top5Unregistered.length) { %>
                                <div class="alert alert-info mb-0"><i class="fa fa-info-circle mr-2"></i>No unregistered crops were suggested.</div>
                            <% } else { %>
                                <% currentPrediction.top5Unregistered.forEach(function(crop, idx) { %>
                                    <div class="recommendation-card" onclick="openCropModal('unregistered', <%= idx %>)">
                                        <div class="crop-rank" style="background:#17a2b8;"><%= idx + 1 %></div>
                                        <div class="w-100">
                                            <div class="crop-name">
                                                <%= crop.name %>
                                                <span class="crop-status unregistered">Unregistered</span>
                                            </div>
                                            <div class="crop-match">
                                                <div class="match-bar">
                                                    <div class="match-bar-inner" style="width:<%= Math.min(100, Math.round(crop.score || crop.ruleBasedScore || 0)) %>%"></div>
                                                </div>
                                                <span><%= Math.round(crop.score || crop.ruleBasedScore || 0) %>% Match</span>
                                            </div>
                                        </div>
                                    </div>
                                <% }); %>
                            <% } %>
                        </div>
                    </section>
                <% } %>

                <nav aria-label="Prediction pagination" class="mt-4">
                    <ul class="pagination pagination-lg justify-content-center">
                        <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                            <a class="page-link" href="?page=1">First</a>
                        </li>
                        <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                            <a class="page-link" href="?page=<%= Math.max(1, currentPage - 1) %>">Previous</a>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link">Page <%= currentPage %> of <%= totalPages %></span>
                        </li>
                        <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                            <a class="page-link" href="?page=<%= Math.min(totalPages, currentPage + 1) %>">Next</a>
                        </li>
                        <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                            <a class="page-link" href="?page=<%= totalPages %>">Last</a>
                        </li>
                    </ul>
                </nav>
            </div>
            <footer class="page-footer">
                <div class="font-13">2025 © <b>NetHouseAutomation</b> - All rights reserved.</div>
                <div class="to-top"><i class="fa fa-angle-double-up"></i></div>
            </footer>
        </div>
    </div>

    <div class="modal fade" id="cropDetailsModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title font-weight-bold" id="cropModalTitle"></h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="section-title d-flex align-items-center gap-2"><i class="fas fa-info-circle text-primary"></i>Crop Information</div>
                                <table class="table table-sm">
                                    <tr><td>Name:</td><td id="cropNameCell"></td></tr>
                                    <tr><td>Status:</td><td><span id="cropStatusBadge" class="badge"></span></td></tr>
                                    <tr><td>Priority Level:</td><td id="cropPriority"></td></tr>
                                    <tr><td>Last Updated:</td><td id="cropLastUpdated"></td></tr>
                                    <tr><td>Summary:</td><td id="cropSummary"></td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <div class="section-title d-flex align-items-center gap-2"><i class="fas fa-star text-warning"></i>Scores & Match</div>
                                <table class="table table-sm">
                                    <tr><td>Overall Match:</td><td id="cropOverallMatch"></td></tr>
                                    <tr><td>ML Score:</td><td id="cropMlScore"></td></tr>
                                    <tr><td>Rule‑based Score:</td><td id="cropRuleScore"></td></tr>
                                    <tr><td>Registered Boost:</td><td id="cropBoost"></td></tr>
                                    <tr><td>Best Match Param:</td><td id="cropBestMatch"></td></tr>
                                    <tr><td>Needs Attention:</td><td id="cropWorstMatch"></td></tr>
                                </table>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="section-title d-flex align-items-center gap-2"><i class="fas fa-bullseye text-success"></i>Optimal Conditions</div>
                                <div id="optimalConditionsContainer" class="small"></div>
                            </div>
                            <div class="col-md-6">
                                <div class="section-title d-flex align-items-center gap-2"><i class="fas fa-chart-line text-info"></i>Parameter Matches</div>
                                <div id="parameterMatchesContainer"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/assets/vendors/jquery/dist/jquery.min.js"></script>
    <script src="/assets/vendors/popper.js/dist/umd/popper.min.js"></script>
    <script src="/assets/vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <script>
        const predictionData = document.getElementById('prediction-data')
            ? JSON.parse(document.getElementById('prediction-data').dataset.prediction || '{}')
            : null;

        function getProgressColor(value) {
            if (value >= 80) return '#28a745';
            if (value >= 60) return '#5cb85c';
            if (value >= 40) return '#f0ad4e';
            return '#dc3545';
        }

        function renderKeyValueTable(obj) {
            if (!obj || typeof obj !== 'object') {
                return '<div class="text-muted">No data</div>';
            }
            const rows = Object.entries(obj)
                .map(([key, value]) => `
                    <div class="d-flex justify-content-between border-bottom py-1">
                        <span class="text-capitalize text-muted">${key.replace(/_/g, ' ')}</span>
                        <span>${value ?? 'N/A'}</span>
                    </div>
                `).join('');
            return rows || '<div class="text-muted">No data</div>';
        }

        function openCropModal(type, index) {
            if (!predictionData) return;
            const list = type === 'registered' ? predictionData.top5Registered : predictionData.top5Unregistered;
            const crop = list && list[index];
            if (!crop) return;

            $('#cropModalTitle').text(crop.name);
            const statusBadge = document.getElementById('cropStatusBadge');
            statusBadge.className = \`badge badge-\${type === 'registered' ? 'success' : 'info'}\`;
            statusBadge.textContent = type === 'registered' ? 'Registered' : 'Unregistered';

            const score = Math.round(crop.score || crop.ruleBasedScore || 0);
            document.getElementById('cropOverallMatch').textContent = \`\${score}%\`;
            document.getElementById('cropSummary').textContent = crop.summary || 'No summary provided.';

            const matches = crop.parameterMatches || {};
            const matchEntries = Object.entries(matches).filter(([, value]) => typeof value === 'number');
            const bestMatch = matchEntries.reduce((best, current) => current[1] > best[1] ? current : best, ['', 0]);
            const worstMatch = matchEntries.reduce((worst, current) => current[1] < worst[1] ? current : worst, ['', 100]);

            document.getElementById('cropBestMatch').textContent = bestMatch[0] ? \`\${bestMatch[0].replace('npk_', '').toUpperCase()} (\${Math.round(bestMatch[1])}%)\` : '--';
            document.getElementById('cropWorstMatch').textContent = worstMatch[0] ? \`\${worstMatch[0].replace('npk_', '').toUpperCase()} (\${Math.round(worstMatch[1])}%)\` : '--';

            document.getElementById('optimalConditionsContainer').innerHTML = renderKeyValueTable(crop.optimalConditions);

            if (matchEntries.length) {
                document.getElementById('parameterMatchesContainer').innerHTML = matchEntries.map(([key, value]) => `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>${key.replace('npk_', '').toUpperCase()}</span>
                            <span>${Math.round(value)}%</span>
                        </div>
                        <div class="progress" style="height:8px;">
                            <div class="progress-bar" role="progressbar"
                                 style="width:${value}%;background:${getProgressColor(value)}"></div>
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('parameterMatchesContainer').innerHTML = '<div class="text-muted">No parameter matches recorded.</div>';
            }

            $('#cropDetailsModal').modal('show');
        }
    </script>
</body>
</html>

