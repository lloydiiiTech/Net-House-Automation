<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width initial-scale=1.0">
    <title>NetHouseAutomation Dashboard</title>
    <!-- GLOBAL MAINLY STYLES-->
    <link href="./assets/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="./assets/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="./assets/vendors/themify-icons/css/themify-icons.css" rel="stylesheet" />
    <!-- PLUGINS STYLES-->
    <link href="./assets/vendors/jvectormap/jquery-jvectormap-2.0.3.css" rel="stylesheet" />
    <!-- THEME STYLES-->
    <link href="assets/css/main.min.css" rel="stylesheet" />
    <!-- PAGE LEVEL STYLES-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="./assets/vendors/fullcalendar/dist/fullcalendar.min.css" rel="stylesheet" />
    <link href="./assets/vendors/fullcalendar/dist/fullcalendar.print.min.css" rel="stylesheet" media="print" />

</head>

<body class="fixed-navbar">
    <div class="page-wrapper">
        <!-- START HEADER-->
        <header class="header">
            <div class="page-brand">
                <a class="link" href="/admin-dashboard">
                    <span class="brand">Demo
                        <span class="brand-tip">FARM</span>
                    </span>
                    <span class="brand-mini">DF</span>
                </a>
            </div>
            <div class="flexbox flex-1">
                <!-- START TOP-LEFT TOOLBAR-->
                <ul class="nav navbar-toolbar">
                    <li>
                        <a class="nav-link sidebar-toggler js-sidebar-toggler"><i class="ti-menu"></i></a>
                    </li>
                    <!--<li>
                        <form class="navbar-search" action="javascript:;">
                            <div class="rel">
                                <span class="search-icon"><i class="ti-search"></i></span>
                                <input class="form-control" placeholder="Search here...">
                            </div>
                        </form>
                    </li>-->
                </ul>
                <!-- END TOP-LEFT TOOLBAR-->
                <!-- START TOP-RIGHT TOOLBAR-->
                <ul class="nav navbar-toolbar">
                    
                    <li class="dropdown dropdown-user">
                        <a class="nav-link dropdown-toggle link" data-toggle="dropdown">
                            <img src="./assets/img/admin-avatar.png" />
                            <span></span>Admin<i class="fa fa-angle-down m-l-5"></i></a>
                        <ul class="dropdown-menu dropdown-menu-right">
                            <a class="dropdown-item" href="/admin-profile"><i class="fa fa-user"></i>Profile</a>
                            <li class="dropdown-divider"></li>
                            <a class="dropdown-item" href="/logout"><i class="fa fa-power-off"></i>Logout</a>
                        </ul>
                    </li>
                </ul>
                <!-- END TOP-RIGHT TOOLBAR-->
            </div>
        </header>
        <!-- END HEADER-->
        <!-- START SIDEBAR-->
        <nav class="page-sidebar" id="sidebar">
            <div id="sidebar-collapse">
                <div class="admin-block d-flex">
                    <div>
                        <img src="./assets/img/admin-avatar.png" width="45px" />
                    </div>
                    <div class="admin-info">
                        <div class="font-strong">Dan Lloyd</div><small>User</small></div>
                </div>
                <ul class="side-menu metismenu">
                    <li>
                        <a class="active" href="/admin-dashboard"><i class="sidebar-item-icon fas fa-tachometer-alt"></i>
                            <span class="nav-label">Dashboard</span>
                        </a>
                    </li>
                    
                    <li>
                        <a class="active" href="/admin-plant-overview"><i class="sidebar-item-icon fas fa-leaf"></i>
                            <span class="nav-label">Plant Overview</span>
                        </a>
                    </li>
                    <li>
                        <a class="active" href="/admin-irrigation-controll"><i class="sidebar-item-icon fas fa-faucet"></i>
                            <span class="nav-label">Irrigation Controll</span>
                        </a>
                    </li>
                    <li>
                        <a class="active" href="/admin-reports&analytics"><i class="sidebar-item-icon fas fa-chart-bar"></i>
                            <span class="nav-label">Reports & Analytics</span>
                        </a>
                    </li>
                    <li>
                        <a class="active" href="/admin-user-management"><i class="sidebar-item-icon fas fa-users-cog"></i>
                            <span class="nav-label">User Management</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
        <div class="content-wrapper">
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h1 class="mb-1">Plant Overview</h1>
                    <div class="current-crop-display">
                        <span class="label">Current Crop: </span>
                        <span class="value" id="current-crop">Tomato</span>
                    </div>
                </div>
                <button class="btn btn-primary harvest-btn mt-3" id="harvest-btn">
                  <i class="fas fa-sickle"></i> Harvest
              </button>
            </div>
            <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

            <style>
            .current-crop-display {
                font-size: 1.1rem;
                color: #555;
            }
            .current-crop-display .value {
                font-weight: 600;
                color: #2a7f62;
            }
            .harvest-btn {
                padding: 8px 20px;
                border-radius: 6px;
                background-color: #2a7f62;
                border: none;
                white-space: nowrap;
                align-self: flex-end; /* Aligns button to bottom */
            }
            </style>
            <div class="page-content fade-in-up">
                <div class="row">
                    <!-- Left side - 3x3 sensor grid -->
                    <div class="col-lg-8">
                        <div class="sensor-grid">
                            <!-- Row 1 -->
                            <div class="sensor-card">
                                <div class="sensor-icon bg-success">
                                    <i class="fas fa-atom"></i>
                                </div>
                                <div class="sensor-value">51.3 ppm</div>
                                <div class="sensor-label">Nitrogen (N)</div>
                                <div class="sensor-status text-success">
                                    <i class="fa fa-check-circle"></i> Optimal
                                </div>
                            </div>
                            
                            <div class="sensor-card">
                                <div class="sensor-icon bg-info">
                                    <i class="fas fa-fire"></i>
                                </div>
                                <div class="sensor-value">31.0 ppm</div>
                                <div class="sensor-label">Phosphorus (P)</div>
                                <div class="sensor-status text-warning">
                                    <i class="fa fa-exclamation-circle"></i> Low
                                </div>
                            </div>
                            
                            <div class="sensor-card">
                                <div class="sensor-icon bg-warning">
                                    <i class="fas fa-bolt"></i>
                                </div>
                                <div class="sensor-value">41.9 ppm</div>
                                <div class="sensor-label">Potassium (K)</div>
                                <div class="sensor-status text-success">
                                    <i class="fa fa-check-circle"></i> Normal
                                </div>
                            </div>
                            
                            <!-- Row 2 -->
                            <div class="sensor-card">
                                <div class="sensor-icon bg-info">
                                    <i class="fas fa-tint"></i>
                                </div>
                                <div class="sensor-value">65%</div>
                                <div class="sensor-label">Humidity</div>
                                <div class="sensor-status text-success">
                                    <i class="fa fa-check-circle"></i> Ideal
                                </div>
                            </div>
                            
                            <div class="sensor-card">
                                <div class="sensor-icon bg-danger">
                                    <i class="fas fa-thermometer-half"></i>
                                </div>
                                <div class="sensor-value">28°C</div>
                                <div class="sensor-label">Temperature</div>
                                <div class="sensor-status text-success">
                                    <i class="fa fa-check-circle"></i> Optimal
                                </div>
                            </div>
                            
                            <div class="sensor-card">
                                <div class="sensor-icon bg-primary">
                                    <i class="fas fa-water"></i>
                                </div>
                                <div class="sensor-value">45%</div>
                                <div class="sensor-label">Soil Moisture</div>
                                <div class="sensor-status text-warning">
                                    <i class="fa fa-exclamation-circle"></i> Low
                                </div>
                            </div>
                            
                            <!-- Row 3 -->
                            <div class="sensor-card">
                                <div class="sensor-icon bg-purple">
                                    <i class="fas fa-flask"></i>
                                </div>
                                <div class="sensor-value">6.5</div>
                                <div class="sensor-label">pH Level</div>
                                <div class="sensor-status text-success">
                                    <i class="fa fa-check-circle"></i> Ideal
                                </div>
                            </div>
                            
                            <div class="sensor-card">
                                <div class="sensor-icon bg-warning">
                                    <i class="fas fa-sun"></i>
                                </div>
                                <div class="sensor-value">850 lux</div>
                                <div class="sensor-label">Light</div>
                                <div class="sensor-status text-success">
                                    <i class="fa fa-check-circle"></i> Good
                                </div>
                            </div>
                            
                            <div class="sensor-card">
                                <div class="sensor-icon bg-teal">
                                    <i class="fas fa-cloud-sun"></i>
                                </div>
                                <div class="sensor-value">Sunny</div>
                                <div class="sensor-label">Weather</div>
                                <div class="sensor-status text-success">
                                    <i class="fa fa-check-circle"></i> Clear
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right side - Top 5 crops prediction -->
                    <div class="col-lg-4">
                        <div class="recommendation-box">
                          <div class="recommendation-header">
                            <h3><i class="fas fa-seedling"></i> Top 5 Recommended Crops</h3>
                          </div>
                          <div class="recommendation-list" id="recommended-crops-list">
                            <% if (recommendations.length > 0) { %>
                              <% recommendations.forEach((crop, index) => { %>
                                <div class="crop-item" 
                                     onclick="showCropDetails(<%= JSON.stringify(crop) %>, <%= JSON.stringify(sensorData) %>)">
                                  <div class="crop-rank"><%= index + 1 %></div>
                                  <div class="crop-info">
                                    <div class="crop-name">
                                      <%= crop.name %>
                                      <span class="crop-status <%= crop.isRegistered ? 'registered' : 'new' %>">
                                        <%= crop.isRegistered ? 'Registered' : 'New' %>
                                      </span>
                                    </div>
                                    <div class="crop-match">
                                      <div class="match-bar" style="width: <%= crop.score || crop.ruleBasedScore %>%"></div>
                                      <span><%= Math.round(crop.score || crop.ruleBasedScore) %>% Match</span>
                                    </div>
                                  </div>
                                  <div class="crop-select">
                                    <i class="fas fa-chevron-right"></i>
                                  </div>
                                </div>
                              <% }); %>
                            <% } else { %>
                              <div class="text-center py-3">No crop recommendations available</div>
                            <% } %>
                          </div>
                        </div>
                      </div>
                      

                      <!-- Modal -->
<div class="modal fade" id="cropDetailsModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <!-- Modal Header -->
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title font-weight-bold" id="cropModalTitle"></h5>
          <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        
        <!-- Modal Body -->
        <div class="modal-body">
          <div class="container-fluid">
            <!-- First Row: Basic Info -->
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="d-flex align-items-center mb-2">
                  <i class="fas fa-info-circle text-primary mr-2"></i>
                  <h6 class="mb-0 font-weight-bold">Crop Information</h6>
                </div>
                <div class="card shadow-sm">
                  <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                      <span class="text-muted">Status:</span>
                      <span id="cropStatus" class="badge"></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                      <span class="text-muted">Overall Match:</span>
                      <span id="overallMatch" class="font-weight-bold"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                      <span class="text-muted">Last Updated:</span>
                      <span id="lastUpdated"></span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="d-flex align-items-center mb-2">
                  <i class="fas fa-star text-warning mr-2"></i>
                  <h6 class="mb-0 font-weight-bold">Quick Stats</h6>
                </div>
                <div class="card shadow-sm">
                  <div class="card-body">
                    <div class="row text-center">
                      <div class="col-4 border-right">
                        <div class="text-muted small">Best Match</div>
                        <div id="bestMatchParam" class="font-weight-bold"></div>
                      </div>
                      <div class="col-4 border-right">
                        <div class="text-muted small">Needs Attention</div>
                        <div id="worstMatchParam" class="font-weight-bold"></div>
                      </div>
                      
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Second Row: Comparison Data -->
            <div class="row">
              <div class="col-md-6">
                <div class="d-flex align-items-center mb-2">
                  <i class="fas fa-bullseye text-success mr-2"></i>
                  <h6 class="mb-0 font-weight-bold">Optimal Conditions</h6>
                </div>
                <div class="card shadow-sm h-100">
                  <div class="card-body" id="optimalConditions"></div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="d-flex align-items-center mb-2">
                  <i class="fas fa-tachometer-alt text-info mr-2"></i>
                  <h6 class="mb-0 font-weight-bold">Environment Data</h6>
                </div>
                <div class="card shadow-sm h-100">
                  <div class="card-body" id="currentSensorData"></div>
                </div>
              </div>
            </div>
            
            <!-- Third Row: Parameter Matches -->
            <div class="row mt-4">
              <div class="col-12">
                <div class="d-flex align-items-center mb-2">
                  <i class="fas fa-percentage text-danger mr-2"></i>
                  <h6 class="mb-0 font-weight-bold">Parameter Matching Analysis</h6>
                </div>
                <div class="card shadow-sm">
                  <div class="card-body" id="parameterMatches"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="modal-footer">
         
          <button type="button" class="btn btn-primary" id="confirmCropBtn">
            <i class="fas fa-check mr-2"></i>Confirm Selection
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <style>
    .toast {
    transition: opacity 0.3s ease;
  }
  
  /* Modal loading state */
  .btn-loading {
    position: relative;
  }
  
  .btn-loading .spinner-border {
    position: relative;
    top: -1px;
  }
  
  /* Current crop highlight */
  #current-crop {
    font-weight: 600;
    color: #2a7f62;
    background-color: #f0f7f4;
    padding: 2px 8px;
    border-radius: 4px;
  }
  /* Modal Enhancements */
  #cropDetailsModal .modal-header {
    border-bottom: 2px solid rgba(255,255,255,0.1);
  }
  
  #cropDetailsModal .modal-content {
    border: none;
    border-radius: 0.5rem;
    overflow: hidden;
  }
  
  #cropDetailsModal .card {
    border: none;
    border-radius: 0.5rem;
  }
  
  .param-card {
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
  }
  
  .param-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  }
  
  .match-indicator {
    height: 8px;
    border-radius: 4px;
    background: linear-gradient(90deg, #f8f9fa 0%, #f8f9fa 100%);
    position: relative;
    overflow: hidden;
  }
  
  .match-progress {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    border-radius: 4px;
  }
  
  /* Status Badges */
  .badge-registered {
    background-color: #28a745;
    color: white;
  }
  
  .badge-new {
    background-color: #17a2b8;
    color: white;
  }
  
  /* Parameter Quality Colors */
  .excellent-match { border-left-color: #28a745; }
  .good-match { border-left-color: #5cb85c; }
  .fair-match { border-left-color: #f0ad4e; }
  .poor-match { border-left-color: #d9534f; }
  



  /* Alert positioning */
.fixed-top {
  position: fixed;
  top: 20px;
  left: 0;
  right: 0;
}

/* Modal transition */
.modal.fade .modal-dialog {
  transition: transform 0.3s ease-out, opacity 0.3s ease;
}

/* Button loading state */
.btn-loading {
  position: relative;
}

.btn-loading .spinner-border {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
}
  </style>
  
  <script>
    
  function showCropDetails(crop, sensorData) {
    // Set modal title and basic info
    document.getElementById('cropModalTitle').textContent = crop.name;
    document.getElementById('cropStatus').className = `badge ${crop.isRegistered ? 'badge-registered' : 'badge-new'}`;
    document.getElementById('cropStatus').textContent = crop.isRegistered ? 'Registered Crop' : 'New Crop';
    document.getElementById('overallMatch').textContent = `${Math.round(crop.score || crop.ruleBasedScore)}%`;
    document.getElementById('lastUpdated').textContent = crop.lastUpdated ? 
      new Date(crop.lastUpdated.seconds * 1000).toLocaleString() : 'N/A';
  
    // Find best and worst matches
    const matches = crop.parameterMatches || {};
    const matchEntries = Object.entries(matches);
    const bestMatch = matchEntries.reduce((a, b) => a[1] > b[1] ? a : b, ['', 0]);
    const worstMatch = matchEntries.reduce((a, b) => a[1] < b[1] ? a : b, ['', 100]);
    
    document.getElementById('bestMatchParam').textContent = `${bestMatch[0].replace('npk_', '').toUpperCase()} (${Math.round(bestMatch[1])}%)`;
    document.getElementById('worstMatchParam').textContent = `${worstMatch[0].replace('npk_', '').toUpperCase()} (${Math.round(worstMatch[1])}%)`;
  
    // Display optimal conditions
    const optimalHtml = `
      <table class="table table-sm table-borderless">
        <tbody>
          <tr>
            <td class="text-muted" width="40%">Temperature</td>
            <td class="font-weight-bold">${crop.optimalConditions?.temperature || 'N/A'}°C</td>
          </tr>
          <tr>
            <td class="text-muted">Humidity</td>
            <td class="font-weight-bold">${crop.optimalConditions?.humidity || 'N/A'}%</td>
          </tr>
          <tr>
            <td class="text-muted">Soil Moisture</td>
            <td class="font-weight-bold">${crop.optimalConditions?.moisture || 'N/A'}%</td>
          </tr>
          <tr>
            <td class="text-muted">pH Level</td>
            <td class="font-weight-bold">${crop.optimalConditions?.ph || 'N/A'}</td>
          </tr>
          <tr>
            <td class="text-muted">Light Intensity</td>
            <td class="font-weight-bold">${crop.optimalConditions?.light || 'N/A'} lux</td>
          </tr>
          <tr>
            <td class="text-muted">Nitrogen (N)</td>
            <td class="font-weight-bold">${crop.optimalConditions?.npk_N || 'N/A'} ppm</td>
          </tr>
          <tr>
            <td class="text-muted">Phosphorus (P)</td>
            <td class="font-weight-bold">${crop.optimalConditions?.npk_P || 'N/A'} ppm</td>
          </tr>
          <tr>
            <td class="text-muted">Potassium (K)</td>
            <td class="font-weight-bold">${crop.optimalConditions?.npk_K || 'N/A'} ppm</td>
          </tr>
        </tbody>
      </table>
    `;
    document.getElementById('optimalConditions').innerHTML = optimalHtml;
  
    // Display current sensor data
    const sensorHtml = `
      <table class="table table-sm table-borderless">
        <tbody>
          <tr>
            <td class="text-muted" width="40%">Temperature</td>
            <td class="font-weight-bold">${sensorData.temperature || 'N/A'}°C</td>
          </tr>
          <tr>
            <td class="text-muted">Humidity</td>
            <td class="font-weight-bold">${sensorData.humidity || 'N/A'}%</td>
          </tr>
          <tr>
            <td class="text-muted">Soil Moisture</td>
            <td class="font-weight-bold">${sensorData.moisture || 'N/A'}%</td>
          </tr>
          <tr>
            <td class="text-muted">pH Level</td>
            <td class="font-weight-bold">${sensorData.ph || 'N/A'}</td>
          </tr>
          <tr>
            <td class="text-muted">Light Intensity</td>
            <td class="font-weight-bold">${sensorData.light || 'N/A'} lux</td>
          </tr>
          <tr>
            <td class="text-muted">Nitrogen (N)</td>
            <td class="font-weight-bold">${sensorData.npk_N || sensorData.nitrogen || 'N/A'} ppm</td>
          </tr>
          <tr>
            <td class="text-muted">Phosphorus (P)</td>
            <td class="font-weight-bold">${sensorData.npk_P || sensorData.phosphorus || 'N/A'} ppm</td>
          </tr>
          <tr>
            <td class="text-muted">Potassium (K)</td>
            <td class="font-weight-bold">${sensorData.npk_K || sensorData.potassium || 'N/A'} ppm</td>
          </tr>
        </tbody>
      </table>
    `;
    document.getElementById('currentSensorData').innerHTML = sensorHtml;
  
    // Display parameter matches with quality indicators
    const matchesHtml = Object.entries(matches).map(([key, value]) => {
      const paramName = key.replace('npk_', '').toUpperCase();
      const matchClass = value >= 80 ? 'excellent-match' : 
                        value >= 60 ? 'good-match' :
                        value >= 40 ? 'fair-match' : 'poor-match';
      
      return `
        <div class="param-card ${matchClass} p-3 mb-2">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <span class="font-weight-bold">${paramName}</span>
            <span class="badge badge-light">${Math.round(value)}%</span>
          </div>
          <div class="match-indicator">
            <div class="match-progress" style="width: ${value}%; background-color: ${getProgressColor(value)};"></div>
          </div>
          <div class="d-flex justify-content-between mt-1">
            <small class="text-muted">Optimal: ${crop.optimalConditions?.[key] || 'N/A'}</small>
            <small class="text-muted">Current: ${sensorData[key] || sensorData[key.toLowerCase()] || 'N/A'}</small>
          </div>
        </div>
      `;
    }).join('');
    document.getElementById('parameterMatches').innerHTML = matchesHtml;
  
    // Show modal
    $('#cropDetailsModal').modal('show');
    
    // Store selected crop for confirmation
    window.selectedCrop = crop;
  }
  
  function getProgressColor(value) {
    if (value >= 80) return '#28a745';
    if (value >= 60) return '#5cb85c';
    if (value >= 40) return '#f0ad4e';
    return '#d9534f';
  }
  
  document.getElementById('confirmCropBtn').addEventListener('click', function() {
    if (window.selectedCrop) {
      // Here you would typically send this to your server
      console.log('Confirmed crop:', window.selectedCrop);
      // Update current crop display
      document.getElementById('current-crop').textContent = window.selectedCrop.name;
      // Close modal
      $('#cropDetailsModal').modal('hide');
    }
  });
  </script>

  <script>
    document.getElementById('confirmCropBtn').addEventListener('click', async function() {
  if (window.selectedCrop) {
    try {
      // Show loading state
      const confirmBtn = document.getElementById('confirmCropBtn');
      const originalText = confirmBtn.innerHTML;
      confirmBtn.disabled = true;
      confirmBtn.innerHTML = `
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Planting...
      `;
      
      // Prepare crop data for saving
      const cropData = {
        ...window.selectedCrop,
        // Include only necessary data
        name: window.selectedCrop.name,
        isRegistered: window.selectedCrop.isRegistered,
        optimalConditions: window.selectedCrop.optimalConditions,
        parameterMatches: window.selectedCrop.parameterMatches,
        score: window.selectedCrop.score || window.selectedCrop.ruleBasedScore
      };

      // Save to Firestore
      const response = await fetch('/confirmCropSelection', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ cropData }),
        credentials: 'include' // Important for session cookies
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'Failed to save crop');
      }

      // Update UI
      document.getElementById('current-crop').textContent = window.selectedCrop.name;
      
      // Show success toast
      showToast('success', result.message || 'Crop planted successfully!');
      
      // Close modal after delay
      setTimeout(() => {
        $('#cropDetailsModal').modal('hide');
      }, 1500);
      
    } catch (error) {
      console.error('Error confirming crop:', error);
      showToast('danger', error.message || 'Failed to plant crop');
    } finally {
      // Reset button state
      const confirmBtn = document.getElementById('confirmCropBtn');
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = originalText;
    }
  }
});

// Toast notification function
function showToast(type, message) {
  const toastContainer = document.getElementById('toastContainer');
  if (!toastContainer) {
    console.error('Toast container not found');
    return;
  }
  
  const toastId = `toast-${Date.now()}`;
  const toast = document.createElement('div');
  toast.id = toastId;
  toast.className = `toast show align-items-center text-white bg-${type} border-0`;
  toast.role = 'alert';
  toast.setAttribute('aria-live', 'assertive');
  toast.setAttribute('aria-atomic', 'true');
  toast.style.position = 'fixed';
  toast.style.top = '20px';
  toast.style.right = '20px';
  toast.style.zIndex = '9999';
  toast.style.minWidth = '250px';
  
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">
        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} me-2"></i>
        ${message}
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  `;
  
  toastContainer.appendChild(toast);
  
  // Auto-remove toast after 5 seconds
  setTimeout(() => {
    const bootstrapToast = bootstrap.Toast.getOrCreateInstance(toast);
    bootstrapToast.hide();
    toast.addEventListener('hidden.bs.toast', () => {
      toast.remove();
    });
  }, 5000);
}
  </script>
                </div>
            </div>
        </div>
        
        <style>
        /* Sensor Grid Styles */
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .sensor-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            aspect-ratio: 1/1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .sensor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .sensor-icon {
            width: 50px;
            height: 50px;
            margin: 0 auto 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }
        
        .sensor-value {
            font-size: 24px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .sensor-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .sensor-status {
            font-size: 12px;
            margin-top: auto;
        }
        
        /* Current Crop Styles */
        .current-crop-display {
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .current-crop-display .label {
            font-weight: 500;
            color: #666;
            margin-right: 8px;
        }
        
        .current-crop-display .value {
            font-weight: 600;
            color: #2a7f62;
        }
        
        .harvest-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        /* Recommendation Box Styles */
        .recommendation-box {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .recommendation-header {
            background: #2a7f62;
            color: white;
            padding: 15px 20px;
        }
        
        .recommendation-header h3 {
            margin: 0;
            font-size: 18px;
        }
        
        .recommendation-list {
            padding: 0;
        }
        
        .crop-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .crop-item:hover {
            background: #f9f9f9;
        }
        
        .crop-item.active {
            background: #f0f7f4;
        }
        
        .crop-rank {
            width: 30px;
            height: 30px;
            background: #eee;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .crop-item.active .crop-rank,
        .crop-item:hover .crop-rank {
            background: #2a7f62;
            color: white;
        }
        
        .crop-info {
            flex-grow: 1;
        }
        
        .crop-name {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .crop-match {
            display: flex;
            align-items: center;
        }
        
        .match-bar {
            height: 4px;
            background: #2a7f62;
            border-radius: 2px;
            margin-right: 10px;
            width: 50px;
        }
        
        .crop-select {
            color: #999;
        }
        
        .crop-item:hover .crop-select {
            color: #2a7f62;
        }
        
        /* Color Classes */
        .bg-success { background: #28a745; }
        .bg-info { background: #17a2b8; }
        .bg-warning { background: #ffc107; }
        .bg-danger { background: #dc3545; }
        .bg-primary { background: #007bff; }
        .bg-purple { background: #6f42c1; }
        .bg-teal { background: #20c997; }
        
        .text-success { color: #28a745; }
        .text-warning { color: #ffc107; }
        .text-danger { color: #dc3545; }
        </style>
        
        <script>
        // Make crop items interactive
        document.querySelectorAll('.crop-item').forEach(item => {
            item.addEventListener('click', function() {
                // Remove active class from all items
                document.querySelectorAll('.crop-item').forEach(i => {
                    i.classList.remove('active');
                });
                
                // Add active class to clicked item
                this.classList.add('active');
                
                // Update current crop display
                const cropName = this.getAttribute('data-crop');
                document.getElementById('current-crop').textContent = cropName;
            });
        });
        
        // Harvest button functionality
        document.getElementById('harvest-btn').addEventListener('click', () => {
            $('#harvestModal').modal('show');
        });
        </script>
                <style>
                    .visitors-table tbody tr td:last-child {
                        display: flex;
                        align-items: center;
                    }

                    .visitors-table .progress {
                        flex: 1;
                    }

                    .visitors-table .progress-parcent {
                        text-align: right;
                        margin-left: 10px;
                    }
                </style>
             
            <footer class="page-footer">
                <div class="font-13">2025 © <b>NetHouseAutomation</b> - All rights reserved.</div>
                <div class="to-top"><i class="fa fa-angle-double-up"></i></div>
            </footer>
        </div>
    </div>
    <!-- BEGIN THEME CONFIG PANEL-->
    <div class="theme-config">
        <div class="theme-config-toggle"><i class="fa fa-cog theme-config-show"></i><i class="ti-close theme-config-close"></i></div>
        <div class="theme-config-box">
            <div class="text-center font-18 m-b-20">SETTINGS</div>
            <div class="font-strong">LAYOUT OPTIONS</div>
            <div class="check-list m-b-20 m-t-10">
                <label class="ui-checkbox ui-checkbox-gray">
                    <input id="_fixedNavbar" type="checkbox" checked>
                    <span class="input-span"></span>Fixed navbar</label>
                <label class="ui-checkbox ui-checkbox-gray">
                    <input id="_fixedlayout" type="checkbox">
                    <span class="input-span"></span>Fixed layout</label>
                <label class="ui-checkbox ui-checkbox-gray">
                    <input class="js-sidebar-toggler" type="checkbox">
                    <span class="input-span"></span>Collapse sidebar</label>
            </div>
            <div class="font-strong">LAYOUT STYLE</div>
            <div class="m-t-10">
                <label class="ui-radio ui-radio-gray m-r-10">
                    <input type="radio" name="layout-style" value="" checked="">
                    <span class="input-span"></span>Fluid</label>
                <label class="ui-radio ui-radio-gray">
                    <input type="radio" name="layout-style" value="1">
                    <span class="input-span"></span>Boxed</label>
            </div>
            <div class="m-t-10 m-b-10 font-strong">THEME COLORS</div>
            <div class="d-flex m-b-20">
                <div class="color-skin-box" data-toggle="tooltip" data-original-title="Default">
                    <label>
                        <input type="radio" name="setting-theme" value="default" checked="">
                        <span class="color-check-icon"><i class="fa fa-check"></i></span>
                        <div class="color bg-white"></div>
                        <div class="color-small bg-ebony"></div>
                    </label>
                </div>
                <div class="color-skin-box" data-toggle="tooltip" data-original-title="Blue">
                    <label>
                        <input type="radio" name="setting-theme" value="blue">
                        <span class="color-check-icon"><i class="fa fa-check"></i></span>
                        <div class="color bg-blue"></div>
                        <div class="color-small bg-ebony"></div>
                    </label>
                </div>
                <div class="color-skin-box" data-toggle="tooltip" data-original-title="Green">
                    <label>
                        <input type="radio" name="setting-theme" value="green">
                        <span class="color-check-icon"><i class="fa fa-check"></i></span>
                        <div class="color bg-green"></div>
                        <div class="color-small bg-ebony"></div>
                    </label>
                </div>
                <div class="color-skin-box" data-toggle="tooltip" data-original-title="Purple">
                    <label>
                        <input type="radio" name="setting-theme" value="purple">
                        <span class="color-check-icon"><i class="fa fa-check"></i></span>
                        <div class="color bg-purple"></div>
                        <div class="color-small bg-ebony"></div>
                    </label>
                </div>
                <div class="color-skin-box" data-toggle="tooltip" data-original-title="Orange">
                    <label>
                        <input type="radio" name="setting-theme" value="orange">
                        <span class="color-check-icon"><i class="fa fa-check"></i></span>
                        <div class="color bg-orange"></div>
                        <div class="color-small bg-ebony"></div>
                    </label>
                </div>
                <div class="color-skin-box" data-toggle="tooltip" data-original-title="Pink">
                    <label>
                        <input type="radio" name="setting-theme" value="pink">
                        <span class="color-check-icon"><i class="fa fa-check"></i></span>
                        <div class="color bg-pink"></div>
                        <div class="color-small bg-ebony"></div>
                    </label>
                </div>
            </div>
            <div class="d-flex">
                <div class="color-skin-box" data-toggle="tooltip" data-original-title="White">
                    <label>
                        <input type="radio" name="setting-theme" value="white">
                        <span class="color-check-icon"><i class="fa fa-check"></i></span>
                        <div class="color"></div>
                        <div class="color-small bg-silver-100"></div>
                    </label>
                </div>
                <div class="color-skin-box" data-toggle="tooltip" data-original-title="Blue light">
                    <label>
                        <input type="radio" name="setting-theme" value="blue-light">
                        <span class="color-check-icon"><i class="fa fa-check"></i></span>
                        <div class="color bg-blue"></div>
                        <div class="color-small bg-silver-100"></div>
                    </label>
                </div>
                <div class="color-skin-box" data-toggle="tooltip" data-original-title="Green light">
                    <label>
                        <input type="radio" name="setting-theme" value="green-light">
                        <span class="color-check-icon"><i class="fa fa-check"></i></span>
                        <div class="color bg-green"></div>
                        <div class="color-small bg-silver-100"></div>
                    </label>
                </div>
                <div class="color-skin-box" data-toggle="tooltip" data-original-title="Purple light">
                    <label>
                        <input type="radio" name="setting-theme" value="purple-light">
                        <span class="color-check-icon"><i class="fa fa-check"></i></span>
                        <div class="color bg-purple"></div>
                        <div class="color-small bg-silver-100"></div>
                    </label>
                </div>
                <div class="color-skin-box" data-toggle="tooltip" data-original-title="Orange light">
                    <label>
                        <input type="radio" name="setting-theme" value="orange-light">
                        <span class="color-check-icon"><i class="fa fa-check"></i></span>
                        <div class="color bg-orange"></div>
                        <div class="color-small bg-silver-100"></div>
                    </label>
                </div>
                <div class="color-skin-box" data-toggle="tooltip" data-original-title="Pink light">
                    <label>
                        <input type="radio" name="setting-theme" value="pink-light">
                        <span class="color-check-icon"><i class="fa fa-check"></i></span>
                        <div class="color bg-pink"></div>
                        <div class="color-small bg-silver-100"></div>
                    </label>
                </div>
            </div>
        </div>
    </div>
    <!-- END THEME CONFIG PANEL-->
    <!-- BEGIN PAGA BACKDROPS-->
    <div class="sidenav-backdrop backdrop"></div>
    <div class="preloader-backdrop">
        <div class="page-preloader">Loading</div>
    </div>
    <!-- END PAGA BACKDROPS-->
    <!-- CORE PLUGINS-->
    <script src="./assets/vendors/jquery/dist/jquery.min.js" type="text/javascript"></script>
    <script src="./assets/vendors/popper.js/dist/umd/popper.min.js" type="text/javascript"></script>
    <script src="./assets/vendors/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="./assets/vendors/metisMenu/dist/metisMenu.min.js" type="text/javascript"></script>
    <script src="./assets/vendors/jquery-slimscroll/jquery.slimscroll.min.js" type="text/javascript"></script>
    <!-- PAGE LEVEL PLUGINS-->
    <script src="./assets/vendors/chart.js/dist/Chart.min.js" type="text/javascript"></script>
    <script src="./assets/vendors/jvectormap/jquery-jvectormap-2.0.3.min.js" type="text/javascript"></script>
    <script src="./assets/vendors/jvectormap/jquery-jvectormap-world-mill-en.js" type="text/javascript"></script>
    <script src="./assets/vendors/jvectormap/jquery-jvectormap-us-aea-en.js" type="text/javascript"></script>
    <script src="./assets/vendors/moment/min/moment.min.js" type="text/javascript"></script>
    <script src="./assets/vendors/fullcalendar/dist/fullcalendar.min.js" type="text/javascript"></script>
    <script src="./assets/vendors/jquery-ui/jquery-ui.min.js" type="text/javascript"></script>
    
    <!-- CORE SCRIPTS-->
    <script src="assets/js/app.min.js" type="text/javascript"></script>
    <!-- PAGE LEVEL SCRIPTS-->
    <script src="./assets/js/scripts/dashboard_1_demo.js" type="text/javascript"></script>

    <script src="./assets/js/scripts/calendar-demo.js" type="text/javascript"></script>

    <!-- Add this HTML for the harvest modal -->
    <div class="modal fade" id="harvestModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Harvest Crop</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="successRate">Rate the crop success (0-100):</label>
                        <input type="number" class="form-control" id="successRate" min="0" max="100" required>
                        <small class="form-text text-muted">Enter a value between 0 and 100 to rate the crop's success</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmHarvest">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Harvest
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    let currentCropId = null;

    // Function to get active crop
    async function getActiveCrop() {
        try {
            const response = await fetch('/checkActiveCrop');
            const data = await response.json();
            
            if (data.hasActiveCrop) {
                currentCropId = data.cropId;
                document.getElementById('current-crop').textContent = data.cropData.name;
                document.getElementById('harvest-btn').disabled = false;
            } else {
                currentCropId = null;
                document.getElementById('current-crop').textContent = 'None';
                document.getElementById('harvest-btn').disabled = true;
            }
        } catch (error) {
            console.error('Error getting active crop:', error);
        }
    }

    // Call this when page loads
    document.addEventListener('DOMContentLoaded', getActiveCrop);

    // Update the harvest modal and functionality
    document.getElementById('confirmHarvest').addEventListener('click', async () => {
        const successRate = document.getElementById('successRate').value;
        
        if (!successRate || successRate < 0 || successRate > 100) {
            alert('Please enter a valid success rate between 0 and 100');
            return;
        }

        if (!currentCropId) {
            alert('No active crop to harvest');
            return;
        }

        try {
            const response = await fetch('/harvestCrop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    cropId: currentCropId,
                    successRate: parseInt(successRate)
                })
            });

            const data = await response.json();

            if (data.success) {
                // Close modal
                $('#harvestModal').modal('hide');
                
                // Show success message
                alert(data.message);
                
                // Reset form
                document.getElementById('successRate').value = '';
                
                // Update UI
                await getActiveCrop();
            } else {
                alert(data.error || 'Failed to harvest crop');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to harvest crop');
        }
    });

    // Add loading state to harvest button
    document.getElementById('harvest-btn').addEventListener('click', () => {
        if (!currentCropId) {
            alert('No active crop to harvest');
            return;
        }
        $('#harvestModal').modal('show');
    });
    </script>

    <style>
    /* Add these styles to your existing CSS */
    .harvest-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    #harvestModal .modal-content {
        border-radius: 8px;
    }

    #harvestModal .modal-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }

    #harvestModal .form-control:focus {
        border-color: #2a7f62;
        box-shadow: 0 0 0 0.2rem rgba(42, 127, 98, 0.25);
    }

    #harvestModal .btn-primary {
        background-color: #2a7f62;
        border-color: #2a7f62;
    }

    #harvestModal .btn-primary:hover {
        background-color: #236b53;
        border-color: #236b53;
    }

    .spinner-border {
        margin-right: 5px;
    }
    </style>

</body>

</html>